<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import SimpleBLEClient from './ble-client.mjs'

    document.addEventListener('DOMContentLoaded', () => {
      /**
       * Views
       */
      const settingsForm = document.getElementById('settings-form')
      const bleConnectButton = document.getElementById('ble-connect-button')
      const updateView = () => {
        if (client.isConnected()) {
          bleConnectButton.classList.remove('active')
          settingsForm.classList.add('active')
        } else {
          settingsForm.classList.remove('active')
          bleConnectButton.classList.add('active')
        }
      }

      /**
       * Event Handlers
       */
      const handleConnectButtonClick = async () => {
        console.log("接続します")
        await client.connect()
        updateView()
      }
      const handleDisconnectButtonClick = async () => {
        console.log("接続解除します")
        await client.disconnect()
        updateView()
      }

      const toast = document.getElementById('toast')
      toast.addEventListener('animationend', () => {
        toast.className = 'toast'
      })
      const showToast = () => {
        toast.classList.add('visible')
      }

      let submitting = null
      const handleWifiSubmit = async (event) => {
        event.preventDefault();
        if (!client.isConnected()) {
          console.warn('接続されていません')
          return;
        }
        const ssid = document.getElementById('wifi-ssid').value.trimEnd()
        const password = document.getElementById('wifi-password').value.trimEnd()
        if (ssid == null || password == null) {
          console.warn('SSIDとパスワードを入力して下さい')
          return;
        }
        await client.send({ _batch: { ssid, password } })
        console.log('Sent')
        submitting = setTimeout(() => {
          console.error('Timeout')
        }, 1000)
      }
      const handleCharacteristicWritten = ({ key, value }) => {
        if (submitting != null) {
          toast.innerText = 'Preference set [・＿・]'
          showToast()
          clearTimeout(submitting)
          submitting = null
        }
        const elem = document.querySelector(`[name=${key}]`)
        if (elem != null) {
          elem.value = value
        }
      }

      /**
       * BLE Client
       */
      const client = new SimpleBLEClient({
        deviceName: "stk",
        onCharacteristicValueChanged: handleCharacteristicWritten
      })
      client.onDisconnected = () => {
        updateView()
      }

      document.getElementById('ble-connect-button').addEventListener('click', handleConnectButtonClick)
      document.getElementById('ble-disconnect-button').addEventListener('click', handleDisconnectButtonClick)
      document.getElementById('form-wifi').addEventListener('submit', handleWifiSubmit)
    })

  </script>
  <title>Document</title>
</head>

<body>
  <div class="app">
  <div id="toast" class="toast"></div>
</body>
</html>